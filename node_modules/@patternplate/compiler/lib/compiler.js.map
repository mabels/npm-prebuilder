{"version":3,"sources":["../src/compiler.js"],"names":["fs","require","path","webpackEntry","MemoryFS","resolveFrom","webpack","nodeExternals","readPkg","querystring","module","exports","compiler","TO_STRING_LOADER","resolve","CSS_LOADER","HTML_LOADER","COVER","DEMO","PROBE","options","config","cwd","entry","components","bases","process","filter","Boolean","render","cascadeResolve","mount","target","demo","probe","cover","externals","mode","rules","test","use","output","library","libraryTarget","filename","outputFileSystem","id","result","reduce","resolved","base","silent","charAt","pathBases","map","join","Error","pkg","getPkg","deps","Object","keys","dependencies","devDeps","devDependencies","indexOf","existsSync","fragments","split","pkgFragments","slice","pkgId","pkgManifest","replace","bugs","url","args","sync","err"],"mappings":"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","file":"compiler.js","sourcesContent":["const fs = require(\"fs\");\nconst path = require(\"path\");\nconst webpackEntry = require(\"@patternplate/webpack-entry\");\nconst MemoryFS = require(\"memory-fs\");\nconst resolveFrom = require(\"resolve-from\");\nconst webpack = require(\"webpack\");\nconst nodeExternals = require(\"webpack-node-externals\");\nconst readPkg = require(\"read-pkg\");\nconst querystring = require(\"querystring\");\n\nmodule.exports = compiler;\n\nconst TO_STRING_LOADER = require.resolve(\"to-string-loader\");\nconst CSS_LOADER = require.resolve(\"css-loader\");\nconst HTML_LOADER = require.resolve(\"html-loader\");\nconst COVER = require.resolve(\"@patternplate/cover-client\");\nconst DEMO = require.resolve(\"@patternplate/demo-client\");\nconst PROBE = require.resolve(\"@patternplate/probe-client\");\n\nasync function compiler(options) {\n  const fs = new MemoryFS();\n  const {config, cwd} = options;\n\n  const components = await webpackEntry(config.entry, { cwd });\n  const entry = { components };\n  const bases = [cwd, process.cwd()].filter(Boolean);\n\n  const render = cascadeResolve(config.render, {bases, cwd});\n  const mount = cascadeResolve(config.mount, {bases, cwd});\n\n  if (options.target === \"node\") {\n    entry.render = render;\n  }\n\n  if (options.target === \"web\") {\n    entry[\"cover-client\"] =  COVER;\n    entry.demo = DEMO;\n    entry.mount = mount;\n    entry.probe = PROBE;\n  }\n\n  if (typeof config.cover === \"string\") {\n    entry.cover = cascadeResolve(config.cover, {bases, cwd});\n  }\n\n  const compiler = webpack({\n    entry,\n    target: options.target,\n    externals: options.target === \"node\" ? [nodeExternals()] : [],\n    mode: \"development\",\n    module: {\n      rules: [\n        {\n          test: /\\.css$/,\n          use: [TO_STRING_LOADER, CSS_LOADER]\n        },\n        {\n          test: /\\.html$/,\n          use: [HTML_LOADER]\n        }\n      ]\n    },\n    output: {\n      library: \"patternplate-[name]\",\n      libraryTarget: options.target === \"node\" ? \"commonjs2\" : \"window\",\n      path: \"/\",\n      filename: `patternplate.${options.target}.[name].js`\n    }\n  });\n\n  compiler.outputFileSystem = fs;\n  return compiler;\n}\n\nfunction cascadeResolve(id, {bases, cwd}) {\n  const result = bases.reduce((resolved, base) => {\n    if (resolved) {\n      return resolved;\n    }\n    return (resolveFrom.silent || resolveFrom)(base, id);\n  }, '');\n\n  if (typeof result !== \"string\") {\n    // Relative require path\n    if (id.charAt(0) === \".\" || id.charAt(0) === \"/\") {\n      const pathBases = bases.map(base => path.join(base, id));\n      throw new Error(`Relatively required file \"${id}\" does not exist at ${pathBases.join(\", \")}`);\n    }\n\n    // Global require path\n    const pkg = getPkg(cwd) || {};\n    const deps = Object.keys(pkg.dependencies || {});\n    const devDeps = Object.keys(pkg.devDependencies || {});\n\n    if (deps.indexOf(id) === -1 && devDeps.indexOf(id) === -1 && !fs.existsSync(path.join(cwd, \"lerna.json\"))) {\n      throw new Error(`\"${id}\" is not installed as dependency at ${cwd}/package.json. Please make sure to install it via npm.`);\n    }\n\n    const fragments = id.split(\"/\");\n    const pkgFragments = id.charAt(0) === \"@\"\n      ? fragments.slice(0, 2)\n      : fragments.slice(0, 1);\n\n    const pkgId = pkgFragments.join(\"/\");\n    const pkgManifest = resolveFrom.silent(process.cwd(), `${pkgId}/package`);\n\n    if (pkgManifest) {\n      const pkg = require(pkgManifest);\n      throw new Error(`\"${pkgId}\" can be resolved, but \"${id.replace(pkgId, '')}\" is not available, it might be corrupted.\\nPlease reinstall your node_modules and file an issue at ${pkg.bugs.url} if the problem persists.`);\n    } else {\n      throw new Error(`Could not resolve \"${id}\" from ${bases.join(\", \")}`);\n    }\n  }\n\n  return result;\n}\n\nconst getPkg = (...args) => {\n  try {\n    return readPkg.sync(...args);\n  } catch (err) {\n    return null;\n  }\n}\n"]}