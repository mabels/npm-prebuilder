{"version":3,"sources":["../src/widgets.js"],"names":["vm","require","React","ReactDOM","buble","widgets","createSearch","styled","ThemeProvider","document","addEventListener","stateEl","querySelector","JSON","parse","decodeURIComponent","textContent","state","source","code","result","render","mountEl","transpile","terr","themes","light","message","snippet","execute","connect","err","search","selectSearch","get","selectGet","src","selectSrc","onListClick","e","preventDefault","link","getMatch","target","id","getAttribute","itemType","window","parent","postMessage","stringify","type","PatternList","props","base","query","ComponentList","PatternDemo","isStatic","ComponentDemo","el","selector","nodeType","parentNode","matches","pool","map","find","p","filter","contentType","pattern","item","prefix","transform","mod","exports","runInNewContext","module","Error","charAt","length","slice","WidgetError","StyledWidgetError","div","theme","colors","error"],"mappings":";;;;AAAA,MAAMA,KAAKC,QAAQ,IAAR,CAAX;;AACA,MAAMC,QAAQD,QAAQ,OAAR,CAAd;;AACA,MAAME,WAAWF,QAAQ,WAAR,CAAjB;;AACA,MAAMG,QAAQH,QAAQ,OAAR,CAAd;;AAEA,MAAMI,UAAUJ,QAAQ,uBAAR,CAAhB;;iBACuBA,QAAQ,sBAAR,C;MAAhBK,Y,YAAAA,Y;;kBACyBL,QAAQ,0BAAR,C;MAAzBM,M,aAAAA,M;MAAQC,a,aAAAA,a;;AAEfP,QAAQ,gBAAR;;AAEAQ,SAASC,gBAAT,CAA0B,kBAA1B,EAA8C,MAAM;AAClD,QAAMC,UAAUF,SAASG,aAAT,CAAuB,qBAAvB,CAAhB;;AADkD,sBAEpBC,KAAKC,KAAL,CAAWC,mBAAmBJ,QAAQK,WAA3B,CAAX,CAFoB;AAAA,QAE3CC,KAF2C,eAE3CA,KAF2C;AAAA,QAE9BC,MAF8B,eAEpCC,IAFoC;;AAIlD,QAAMC,SAASC,OAAOH,MAAP,EAAeD,KAAf,CAAf;AAEA,QAAMK,UAAUb,SAASG,aAAT,CAAuB,qBAAvB,CAAhB;AACAT,WAASkB,MAAT,CAAgBD,MAAhB,EAAwBE,OAAxB;AACD,CARD;;AAUA,SAASD,MAAT,CAAgBH,MAAhB,EAAwBD,KAAxB,EAA+B;AAAA,qBACRM,UAAUL,MAAV,CADQ;AAAA;AAAA,QACtBM,IADsB;AAAA,QAChBL,IADgB;;AAG7B,MAAIK,IAAJ,EAAU;AACR,WACE,oBAAC,aAAD;AAAe,aAAOP,MAAMQ,MAAN,CAAaC;AAAnC,OACE,oBAAC,WAAD;AAAa,eAASF,KAAKG,OAA3B;AAAoC,eAASH,KAAKI;AAAlD,MADF,CADF;AAKD;;AAT4B,mBAWPC,QAAQV,IAAR,EAAcW,QAAQzB,OAAR,EAAiBY,KAAjB,CAAd,CAXO;AAAA;AAAA,QAWtBc,GAXsB;AAAA,QAWjBX,MAXiB;;AAa7B,MAAIW,GAAJ,EAAS;AACP,WACE,oBAAC,aAAD;AAAe,aAAOd,MAAMQ,MAAN,CAAaC;AAAnC,OACE,oBAAC,WAAD;AAAa,eAASK,IAAIJ,OAA1B;AAAmC,eAASI,IAAIH;AAAhD,MADF,CADF;AAKD;;AAED,SAAOR,MAAP;AACD;;AAED,SAASU,OAAT,CAAiBzB,OAAjB,EAA0BY,KAA1B,EAAiC;AAC/B,QAAMe,SAASC,aAAahB,KAAb,CAAf;AACA,QAAMiB,MAAMC,UAAUlB,KAAV,CAAZ;AACA,QAAMmB,MAAMC,UAAUpB,KAAV,CAAZ;;AAEA,QAAMqB,cAAeC,CAAD,IAAO;AACzBA,MAAEC,cAAF;AACA,UAAMC,OAAOC,SAASH,EAAEI,MAAX,EAAmB,WAAnB,CAAb;;AAEA,QAAIF,IAAJ,EAAU;AACR,YAAMG,KAAKH,KAAKI,YAAL,CAAkB,SAAlB,CAAX;AACA,YAAMC,WAAWL,KAAKI,YAAL,CAAkB,WAAlB,CAAjB;AACAE,aAAOC,MAAP,CAAcC,WAAd,CAA0BpC,KAAKqC,SAAL,CAAe;AAACC,cAAM,UAAP;AAAmBP,UAAnB;AAAuBE;AAAvB,OAAf,CAA1B,EAA4E,GAA5E;AACD;AACF,GATD;;AAWA,SAAO;AACLM,iBAAcC,KAAD,IAAW;AACtB,aACE,oBAAC,aAAD;AAAe,eAAOpC,MAAMQ,MAAN,CAAaC;AAAnC,SACE,oBAAC,OAAD,CAAS,WAAT;AACE,cAAMT,MAAMqC,IADd;AAEE,gBAAQtB,MAFV;AAGE,eAAOqB,MAAME,KAHf;AAIE,iBAASjB;AAJX,QADF,CADF;AAUD,KAZI;AAaLkB,mBAAgBH,KAAD,IAAW;AACxB,aACE,oBAAC,aAAD;AAAe,eAAOpC,MAAMQ,MAAN,CAAaC;AAAnC,SACE,oBAAC,OAAD,CAAS,aAAT;AACE,cAAMT,MAAMqC,IADd;AAEE,gBAAQtB,MAFV;AAGE,eAAOqB,MAAME,KAHf;AAIE,iBAASjB;AAJX,QADF,CADF;AAUD,KAxBI;AAyBLmB,iBAAcJ,KAAD,IAAW;AACtB,aACE,oBAAC,aAAD;AAAe,eAAOpC,MAAMQ,MAAN,CAAaC;AAAnC,SACE,oBAAC,OAAD,CAAS,WAAT;AACE,YAAI2B,MAAMT,EADZ;AAEE,aAAKV,GAFP;AAGE,aAAKE,GAHP;AAIE,gBAAQnB,MAAMyC;AAJhB,QADF,CADF;AAUD,KApCI;AAqCLC,mBAAgBN,KAAD,IAAW;AACxB,aACE,oBAAC,aAAD;AAAe,eAAOpC,MAAMQ,MAAN,CAAaC;AAAnC,SACE,oBAAC,OAAD,CAAS,aAAT;AACE,YAAI2B,MAAMT,EADZ;AAEE,aAAKV,GAFP;AAGE,aAAKE,GAHP;AAIE,gBAAQnB,MAAMyC;AAJhB,QADF,CADF;AAUD;AAhDI,GAAP;AAkDD;;AAED,SAAShB,QAAT,CAAkBkB,EAAlB,EAAsBC,QAAtB,EAAgC;AAC9B,SAAOD,EAAP,EAAW;AACT,QAAIA,GAAGE,QAAH,KAAgB,CAApB,EAAuB;AACrBF,WAAKA,GAAGG,UAAR;AACA;AACD;;AAED,QAAIH,GAAGI,OAAH,CAAWH,QAAX,CAAJ,EAA0B;AACxB,aAAOD,EAAP;AACD;;AAEDA,SAAKA,GAAGG,UAAR;AACD;;AAED,SAAO,IAAP;AACD;;AAED,SAAS9B,YAAT,CAAsBhB,KAAtB,EAA6B;AAC3B,QAAMe,SAAS1B,aAAaW,MAAMgD,IAAnB,CAAf;AACA,SAAOV,SAAS;AACd,WAAOvB,OAAOuB,KAAP,EAAcW,GAAd,CAAkBtB,MAAM3B,MAAMgD,IAAN,CAAWE,IAAX,CAAgBC,KAAKA,EAAExB,EAAF,KAASA,EAA9B,CAAxB,CAAP;AACD,GAFD;AAGD;;AAED,SAAST,SAAT,CAAmBlB,KAAnB,EAA0B;AACxB,SAAO2B,MAAM3B,MAAMgD,IAAN,CAAWI,MAAX,CAAkBD,KAAKA,EAAEE,WAAF,KAAkB,SAAzC,EAAoDH,IAApD,CAAyDI,WAAWA,QAAQ3B,EAAR,KAAeA,EAAnF,CAAb;AACD;;AAED,SAASP,SAAT,CAAmBpB,KAAnB,EAA0B;AACxB,QAAMiB,MAAMC,UAAUlB,KAAV,CAAZ;AACA,SAAO2B,MAAM;AACX,UAAM4B,OAAOtC,IAAIU,EAAJ,CAAb;;AACA,QAAI,CAAC4B,IAAL,EAAW;AACT,aAAO,IAAP;AACD;;AACD,QAAIA,KAAKF,WAAL,KAAqB,SAAzB,EAAoC;AAClC,aAAO,IAAP;AACD;;AACD,WAAQ,GAAEG,OAAOxD,MAAMqC,IAAb,CAAmB,aAAYkB,KAAK5B,EAAG,OAAjD;AACD,GATD;AAUD;;AAED,SAASrB,SAAT,CAAmBL,MAAnB,EAA2B;AACzB,MAAI;AAAA,6BACad,MAAMsE,SAAN,CAAgBxD,MAAhB,CADb;AAAA,UACKC,IADL,oBACKA,IADL;;AAEF,WAAO,CAAC,IAAD,EAAOA,IAAP,CAAP;AACD,GAHD,CAGE,OAAOY,GAAP,EAAY;AACZ,WAAO,CAACA,GAAD,CAAP;AACD;AACF;;AAED,SAASF,OAAT,CAAiBV,IAAjB,EAAuBd,UAAU,EAAjC,EAAqC;AACnC,MAAI;AACF,UAAMsE,MAAM;AAACC,eAAS;AAAV,KAAZ;AAEA5E,OAAG6E,eAAH,CAAoB,gBAAe1D,IAAK,OAAxC,EAAgD;AAC9C2D,cAAQH,GADsC;;AAE9C1E,cAAQ2C,EAAR,EAAY;AACV,YAAIA,OAAO,OAAX,EAAoB;AAClB,iBAAO1C,KAAP;AACD;;AACD,YAAI,uBAAJ,EAA6B;AAC3B,iBAAOG,OAAP;AACD;;AACD,cAAM,IAAI0E,KAAJ,CAAW,qBAAoBnC,EAAG,EAAlC,CAAN;AACD;;AAV6C,KAAhD;AAaA,UAAMxB,SAASuD,IAAIC,OAAnB;;AAEA,QAAI,OAAOxD,MAAP,KAAkB,UAAtB,EAAkC;AAChC,YAAMW,MAAM,IAAIgD,KAAJ,CAAW,oDAAmD,OAAO3D,MAAO,yCAA5E,CAAZ;AACAW,UAAIH,OAAJ,GAAe,gDAAf;AACA,YAAMG,GAAN;AACD;;AAED,WAAO,CAAC,IAAD,EAAOX,QAAP,CAAP;AACD,GAzBD,CAyBE,OAAOW,GAAP,EAAY;AACZ,WAAO,CAACA,GAAD,CAAP;AACD;AACF;;AAED,SAAS0C,MAAT,CAAgBnB,IAAhB,EAAsB;AACpB,SAAOA,KAAK0B,MAAL,CAAY1B,KAAK2B,MAAL,GAAc,CAA1B,MAAiC,GAAjC,GACH3B,KAAK4B,KAAL,CAAW,CAAX,EAAc5B,KAAK2B,MAAL,GAAc,CAA5B,CADG,GAEH3B,IAFJ;AAGD;;AAED,SAAS6B,WAAT,CAAqB9B,KAArB,EAA4B;AAC1B,SACE,oBAAC,iBAAD,QACE,iCAAMA,MAAM1B,OAAZ,CADF,EAEE,iCACG0B,MAAMzB,OADT,CAFF,CADF;AAQD;;AAED,MAAMwD,oBAAoB7E,OAAO8E,GAA3B;AAAA;AAAA,4EACUhC,SAASA,MAAMiC,KAAN,CAAYC,MAAZ,CAAmBC,KADtC,CAAN","file":"widgets.js","sourcesContent":["const vm = require(\"vm\");\nconst React = require(\"react\");\nconst ReactDOM = require(\"react-dom\");\nconst buble = require(\"buble\");\n\nconst widgets = require(\"@patternplate/widgets\");\nconst {createSearch} = require(\"@patternplate/search\");\nconst {styled, ThemeProvider} = require(\"@patternplate/components\");\n\nrequire(\"iframe-resizer\");\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  const stateEl = document.querySelector(\"[data-widget-state]\");\n  const {state, code: source} = JSON.parse(decodeURIComponent(stateEl.textContent));\n\n  const result = render(source, state);\n\n  const mountEl = document.querySelector(\"[data-widget-mount]\");\n  ReactDOM.render(result, mountEl);\n});\n\nfunction render(source, state) {\n  const [terr, code] = transpile(source);\n\n  if (terr) {\n    return (\n      <ThemeProvider theme={state.themes.light}>\n        <WidgetError message={terr.message} snippet={terr.snippet}/>\n      </ThemeProvider>\n    );\n  }\n\n  const [err, result] = execute(code, connect(widgets, state));\n\n  if (err) {\n    return (\n      <ThemeProvider theme={state.themes.light}>\n        <WidgetError message={err.message} snippet={err.snippet}/>\n      </ThemeProvider>\n    );\n  }\n\n  return result;\n}\n\nfunction connect(widgets, state) {\n  const search = selectSearch(state);\n  const get = selectGet(state);\n  const src = selectSrc(state);\n\n  const onListClick = (e) => {\n    e.preventDefault();\n    const link = getMatch(e.target, \"[data-id]\");\n\n    if (link) {\n      const id = link.getAttribute(\"data-id\");\n      const itemType = link.getAttribute(\"data-type\");\n      window.parent.postMessage(JSON.stringify({type: \"navigate\", id, itemType}), \"*\");\n    }\n  };\n\n  return {\n    PatternList: (props) => {\n      return (\n        <ThemeProvider theme={state.themes.light}>\n          <widgets.PatternList\n            base={state.base}\n            search={search}\n            query={props.query}\n            onClick={onListClick}\n            />\n        </ThemeProvider>\n      );\n    },\n    ComponentList: (props) => {\n      return (\n        <ThemeProvider theme={state.themes.light}>\n          <widgets.ComponentList\n            base={state.base}\n            search={search}\n            query={props.query}\n            onClick={onListClick}\n            />\n        </ThemeProvider>\n      );\n    },\n    PatternDemo: (props) => {\n      return (\n        <ThemeProvider theme={state.themes.light}>\n          <widgets.PatternDemo\n            id={props.id}\n            get={get}\n            src={src}\n            reload={state.isStatic}\n            />\n        </ThemeProvider>\n      );\n    },\n    ComponentDemo: (props) => {\n      return (\n        <ThemeProvider theme={state.themes.light}>\n          <widgets.ComponentDemo\n            id={props.id}\n            get={get}\n            src={src}\n            reload={state.isStatic}\n            />\n        </ThemeProvider>\n      );\n    }\n  };\n}\n\nfunction getMatch(el, selector) {\n  while (el) {\n    if (el.nodeType !== 1) {\n      el = el.parentNode;\n      continue;\n    }\n\n    if (el.matches(selector)) {\n      return el;\n    }\n\n    el = el.parentNode;\n  }\n\n  return null;\n}\n\nfunction selectSearch(state) {\n  const search = createSearch(state.pool);\n  return query => {\n    return search(query).map(id => state.pool.find(p => p.id === id));\n  };\n}\n\nfunction selectGet(state) {\n  return id => state.pool.filter(p => p.contentType === \"pattern\").find(pattern => pattern.id === id);\n}\n\nfunction selectSrc(state) {\n  const get = selectGet(state);\n  return id => {\n    const item = get(id);\n    if (!item) {\n      return null;\n    }\n    if (item.contentType !== \"pattern\") {\n      return null;\n    }\n    return `${prefix(state.base)}/api/demo/${item.id}.html`;\n  };\n}\n\nfunction transpile(source) {\n  try {\n    const {code} = buble.transform(source);\n    return [null, code];\n  } catch (err) {\n    return [err];\n  }\n}\n\nfunction execute(code, widgets = {}) {\n  try {\n    const mod = {exports: {}};\n\n    vm.runInNewContext(`(function() {${code}})();`, {\n      module: mod,\n      require(id) {\n        if (id === 'react') {\n          return React;\n        }\n        if ('@patternplate/widgets') {\n          return widgets;\n        }\n        throw new Error(`Could not resolve ${id}`);\n      }\n    });\n\n    const result = mod.exports;\n\n    if (typeof result !== \"function\") {\n      const err = new Error(`widget blocks must export a function, but found \"${typeof result}\". Make sure to export a function e.g.:`);\n      err.snippet = `module.exports = () => <div>Hello World</div>;`;\n      throw err;\n    }\n\n    return [null, result()];\n  } catch (err) {\n    return [err];\n  }\n}\n\nfunction prefix(base) {\n  return base.charAt(base.length - 1) === \"/\"\n    ? base.slice(0, base.length - 1)\n    : base;\n}\n\nfunction WidgetError(props) {\n  return (\n    <StyledWidgetError>\n      <div>{props.message}</div>\n      <pre>\n        {props.snippet}\n      </pre>\n    </StyledWidgetError>\n  );\n}\n\nconst StyledWidgetError = styled.div`\n  background: ${props => props.theme.colors.error};\n  color: #fff;\n  padding: 10px 15px;\n  font-family: monospace;\n`;\n"]}