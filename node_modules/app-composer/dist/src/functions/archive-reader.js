"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const zlib = require("zlib");
const tarstream = require('tar-stream');
function getPackageJsonFromArchive(path) {
    return new Promise((rs, rj) => {
        const extract = tarstream.extract();
        const f = fs.createReadStream(path);
        f.on('error', (err) => {
            rj(err);
        });
        const data = [];
        extract.on('entry', (header, stream, next) => {
            stream.on('end', next);
            if (header.name == 'package/package.json' || header.name == 'package.json') {
                stream.on('data', (streamData) => data.push(streamData.toString()));
            }
            stream.resume();
        });
        extract.on('finish', () => {
            try {
                rs(JSON.parse(data.join('')));
            }
            catch (e) {
                console.log(data.join(''));
                console.error(`unable to parse package json from ${path}`);
                rj(e);
            }
        });
        f.pipe(zlib.createGunzip()).pipe(extract);
    });
}
exports.getPackageJsonFromArchive = getPackageJsonFromArchive;
//# sourceMappingURL=archive-reader.js.map