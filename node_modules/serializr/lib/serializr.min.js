/** serializr - (c) Michel Weststrate 2016 - MIT Licensed */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define("serializr",["exports"],r):r(e.serializr={})}(this,function(e){"use strict";function r(e){if(e)throw new Error(e)}function n(e,r){if(!e)throw new Error("[serializr] "+(r||"Illegal State"))}function t(e,r,n){if(0!==e.length){var t=e.length,i=[],o=!1;e.forEach(function(e,a){r(e,function(e,r,a){r?o||(o=!0,n(r)):(i[e]=a,0==--t&&n(null,i))}.bind(null,a))})}else n(null,[])}function i(e){return null===e||"object"!=typeof e&&"function"!=typeof e}function o(e){return e&&e.factory&&e.props}function a(e){return e&&e.serializer&&e.deserializer}function s(e){return"object"==typeof e&&!!e.jsonname}function u(e,r){for(;e;){if(e===r)return!0;e=e["extends"]}return!1}function l(e){return e&&"function"==typeof e.keys&&"function"==typeof e.clear}function c(e){return e?o(e)?e:o(e.serializeInfo)?e.serializeInfo:e.constructor&&e.constructor.serializeInfo?e.constructor.serializeInfo:void 0:null}function f(e,r){return n(o(r)),e.serializeInfo=r}function p(e,r,t){n(e!==Object,"one cannot simply put define a model schema for Object"),n("function"==typeof e,"expected constructor function");var i={targetClass:e,factory:t||function(){return new e},props:r};if(e.prototype.constructor!==Object){var o=c(e.prototype.constructor);o&&o.targetClass!==e&&(i["extends"]=o)}return f(e,i),i}function d(){return{serializer:function(e){return n(i(e),"this value is not primitive: "+e),e},deserializer:function(e,r){i(e)?r(null,e):r("[serializr] this value is not primitive: "+e)}}}var h="undefined"!=typeof Symbol?Symbol("SKIP"):{SKIP:!0},m=d(),y=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,g=/([^\s,]+)/g;function v(e,r,t,i){var o,s,u;if(n(arguments.length>=2,"too few arguments. Please use @serializable as property decorator"),t===undefined&&"function"==typeof r&&r.prototype&&i!==undefined&&"number"==typeof i){n(a(e),"Constructor params must use alias(name)"),n(e.jsonname,"Constructor params must use alias(name)");var l=(s=r.toString().replace(y,""),null===(u=s.slice(s.indexOf("(")+1,s.indexOf(")")).match(g))&&(u=[]),u);l.length>=i&&(t=l[i],e.paramNumber=i,i=undefined,r=r.prototype,o=function(e){for(var n=[],t=0;t<r.constructor.length;t++)Object.keys(e.modelSchema.props).forEach(function(r){var i=e.modelSchema.props[r];i.paramNumber===t&&(n[t]=e.json[i.jsonname])});return new(Function.prototype.bind.apply(r.constructor,[null].concat(n)))})}n("string"==typeof t,"incorrect usage of @serializable decorator");var f=c(r);return f&&r.constructor.hasOwnProperty("serializeInfo")||(f=p(r.constructor,{},o)),f&&f.targetClass!==r.constructor&&(f=p(r.constructor,{},o)),f.props[t]=e,!i||i.get||i.set||(i.writable=!0),i}function b(e,r){n(1===arguments.length||2===arguments.length,"serialize expects one or 2 arguments");var t=1===arguments.length?e:r,i=1===arguments.length?null:e;if(Array.isArray(t)){if(0===t.length)return[];i||(i=c(t[0]))}else i||(i=c(t));return n(!!i,"Failed to find default schema for "+e),Array.isArray(t)?t.map(function(e){return z(i,e)}):z(i,t)}function z(e,r){var t;return n(e&&"object"==typeof e,"Expected schema"),n(r&&"object"==typeof r,"Expected object"),t=e["extends"]?z(e["extends"],r):{},Object.keys(e.props).forEach(function(o){var a=e.props[o];if("*"===o)return n(!0===a,"prop schema '*' can onle be used with 'true'"),void function(e,r,n){for(var t in r)if(r.hasOwnProperty(t)&&!(t in e.props)){var o=r[t];i(o)&&(n[t]=o)}}(e,r,t);if(!0===a&&(a=m),!1!==a){var s=a.serializer(r[o],o,r);s!==h&&(t[a.jsonname||o]=s)}}),t}function j(e,n,t,i,o){this.parentContext=e,this.isRoot=!e,this.pendingCallbacks=0,this.pendingRefsCount=0,this.onReadyCb=i||r,this.json=t,this.target=null,this.hasError=!1,this.modelSchema=n,this.isRoot?(this.rootContext=this,this.args=o,this.pendingRefs={},this.resolvedRefs={}):(this.rootContext=e.rootContext,this.args=e.args)}function x(e,r){for(var n in e.props)if("object"==typeof e.props[n]&&e.props[n].jsonname===r)return!0;return!1}function R(e,t,i,o,a){if(null!==i&&i!==undefined){var s=new j(e,t,i,o,a),u=t.factory(s);n(!!u,"No object returned from factory"),s.target=u;var l=s.createCallback(r);return C(s,t,i,u),l(),u}o(null,null)}function C(e,r,t,o){r["extends"]&&C(e,r["extends"],t,o),Object.keys(r.props).forEach(function(a){var s=r.props[a];if("*"===a)return n(!0===s,"prop schema '*' can onle be used with 'true'"),void function(e,r,t){for(var o in t)if(!(o in e.props||x(e,o))){var a=t[o];n(i(a),"encountered non primitive value while deserializing '*' properties in property '"+o+"': "+a),r[o]=a}}(r,o,t);if(!0===s&&(s=m),!1!==s){var u=s.jsonname||a;u in t&&s.deserializer(t[u],e.rootContext.createCallback(function(e){e!==h&&(o[a]=e)}),e,o[a])}})}function S(e){return n("object"==typeof e||"function"==typeof e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies."),{serializer:function(r){return n(o(e=c(e)),"expected modelSchema, got "+e),null===r||r===undefined?r:b(e,r)},deserializer:function(r,t,i){n(o(e=c(e)),"expected modelSchema, got "+e),null!==r&&r!==undefined?R(i,e,r,t):t(null,r)}}}function w(e,r){n(!!e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var t,i=!1;function a(){if(i=!0,n("string"!=typeof e||r,"if the reference target is specified by attribute name, a lookup function is required"),n(!r||"function"==typeof r,"second argument should be a lookup function"),"string"==typeof e)t=e;else{var a=c(e);n(o(a),"expected model schema or string as first argument for 'ref', got "+a),r=r||(s=a,function(e,r,n){n.rootContext.await(s,e,r)}),n(!!(t=function(e){for(n(o(e));e;){for(var r in e.props)if("object"==typeof e.props[r]&&!0===e.props[r].identifier)return r;e=e["extends"]}return null}(a)),"provided model schema doesn't define an identifier() property and cannot be used by 'ref'.")}var s}return{serializer:function(e){return i||a(),e?e[t]:null},deserializer:function(e,n,t){i||a(),null===e||e===undefined?n(null,e):r(e,n,t)}}}function k(e){return n(a(e=e||m),"expected prop schema as first argument"),n(!s(e),"provided prop is aliased, please put aliases first"),{serializer:function(r){return n(r&&"length"in r&&"map"in r,"expected array (like) object"),r.map(e.serializer)},deserializer:function(r,n,i){Array.isArray(r)?t(r,function(r,n){return e.deserializer(r,n,i)},n):n("[serializr] expected JSON array")}}}j.prototype.createCallback=function(e){return this.pendingCallbacks++,r=function(r,n){r?this.hasError||(this.hasError=!0,this.onReadyCb(r)):this.hasError||(e(n),--this.pendingCallbacks===this.pendingRefsCount&&(this.pendingRefsCount>0?this.onReadyCb(new Error('Unresolvable references in json: "'+Object.keys(this.pendingRefs).filter(function(e){return this.pendingRefs[e].length>0},this).join('", "')+'"')):this.onReadyCb(null,this.target)))}.bind(this),t=!1,function(){if(!t)return t=!0,r.apply(null,arguments);n(!1,"callback was invoked twice")};var r,t},j.prototype.await=function(e,r,t){if(n(this.isRoot),r in this.resolvedRefs){var i=this.resolvedRefs[r].filter(function(r){return u(r.modelSchema,e)})[0];if(i)return void t(null,i.value)}this.pendingRefsCount++,this.pendingRefs[r]||(this.pendingRefs[r]=[]),this.pendingRefs[r].push({modelSchema:e,uuid:r,callback:t})},j.prototype.resolve=function(e,r,t){if(n(this.isRoot),this.resolvedRefs[r]||(this.resolvedRefs[r]=[]),this.resolvedRefs[r].push({modelSchema:e,value:t}),r in this.pendingRefs)for(var i=this.pendingRefs[r].length-1;i>=0;i--){var o=this.pendingRefs[r][i];u(e,o.modelSchema)&&(this.pendingRefs[r].splice(i,1),this.pendingRefsCount--,o.callback(null,t))}},e.createSimpleSchema=function(e){return{factory:function(){return{}},props:e}},e.createModelSchema=p,e.getDefaultModelSchema=c,e.setDefaultModelSchema=f,e.serializable=function(e,r,t){if(1===arguments.length){var i=!0===e?m:e;return n(a(i),"@serializable expects prop schema"),v.bind(null,i)}return v(d(),e,r,t)},e.serialize=b,e.serializeAll=function(e){n(1===arguments.length&&"function"==typeof e,"@serializeAll can only be used as class decorator");var r=c(e);return r&&e.hasOwnProperty("serializeInfo")||f(e,r=p(e,{})),c(e).props["*"]=!0,e},e.deserialize=function(e,i,a,s){if(n(arguments.length>=2,"deserialize expects at least 2 arguments"),n(o(e=c(e)),"first argument should be model schema"),Array.isArray(i)){var u=[];return t(i,function(r,n){var t=R(null,e,r,n,s);u.push(t)},a||r),u}return R(null,e,i,a,s)},e.update=function(e,t,i,a,s){2===arguments.length||"function"==typeof arguments[2]?(e=c(t=arguments[0]),i=arguments[1],a=arguments[2],s=arguments[3]):e=c(e),n(o(e),"update failed to determine schema"),n("object"==typeof t&&t&&!Array.isArray(t),"update needs an object");var u=new j(null,e,i,a,s);u.target=t;var l=u.createCallback(r);C(u,e,i,t),l()},e.primitive=d,e.identifier=function(e){return n(!e||"function"==typeof e,"First argument should be omitted or function"),{identifier:!0,serializer:m.serializer,deserializer:function(r,n,t){m.deserializer(r,function(r,i){var o,a;o=i,t.target,(a=t).rootContext.resolve(a.modelSchema,o,a.target),e&&e(i,t.target,t),n(r,i)})}}},e.date=function(){return{serializer:function(e){return null===e||e===undefined?e:(n(e instanceof Date,"Expected Date object"),e.getTime())},deserializer:function(e,r){null!==e&&e!==undefined?r(null,new Date(e)):r(null,e)}}},e.alias=function(e,r){return n(e&&"string"==typeof e,"expected prop name as first argument"),n(a(r=r&&!0!==r?r:m),"expected prop schema as second argument"),n(!s(r),"provided prop is already aliased"),{jsonname:e,serializer:r.serializer,deserializer:r.deserializer,identifier:(t=r,"object"==typeof t&&!0===t.identifier)};var t},e.custom=function(e,r){return n("function"==typeof e,"first argument should be function"),n("function"==typeof r,"second argument should be a function or promise"),{serializer:e,deserializer:function(e,n,t,i){4===r.length?r(e,t,i,n):n(null,r(e,t,i))}}},e.object=S,e.reference=w,e.list=k,e.map=function(e){return n(a(e=e||m),"expected prop schema as first argument"),n(!s(e),"provided prop is aliased, please put aliases first"),{serializer:function(r){n(r&&"object"==typeof r,"expected object or Map");var t=l(r),i={};if(t)r.forEach(function(r,n){i[n]=e.serializer(r)});else for(var o in r)i[o]=e.serializer(r[o]);return i},deserializer:function(r,n,t,i){if(r&&"object"==typeof r){var o=Object.keys(r);k(e).deserializer(o.map(function(e){return r[e]}),function(e,r){if(e)n(e);else{var t,a=l(i);a?(i.clear(),t=i):t={};for(var s=0,u=o.length;s<u;s++)a?t.set(o[s],r[s]):t[o[s]]=r[s];n(null,t)}},t)}else n("[serializr] expected JSON object")}}},e.mapAsArray=function(e,r){return n(a(e=e||m),"expected prop schema as first argument"),n(!!r,"expected key property name as second argument"),{serializer:function(r){var n=[];return r.forEach(function(r,t){n.push(e.serializer(r))}),n},deserializer:function(n,t,i,o){k(e).deserializer(n,function(e,i){if(e)t(e);else{var a,s=l(o);s?(o.clear(),a=o):a={};for(var u=0,c=n.length;u<c;u++)s?a.set(i[u][r],i[u]):a[i[u][r].toString()]=i[u];t(null,a)}},i)}}},e.raw=function(){return{serializer:function(e){return e},deserializer:function(e,r){r(null,e)}}},e.SKIP=h,e.child=S,e.ref=w,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=serializr.min.js.map
